services:
  insightface-api:
    # Usar Quay.io como alternativa
    image: quay.io/centos/centos:stream9
    working_dir: /app
    command: |
      bash -c "
        echo 'ðŸš€ Iniciando instalaciÃ³n de InsightFace API...' &&
        dnf update -y &&
        dnf install -y python3 python3-pip python3-devel gcc gcc-c++ make glib2-devel libSM-devel libXext-devel libXrender-devel wget curl &&
        ln -sf /usr/bin/python3 /usr/bin/python &&
        ln -sf /usr/bin/pip3 /usr/bin/pip &&
        echo 'ðŸ“¦ Instalando dependencias Python...' &&
        pip install --no-cache-dir -r requirements.txt &&
        mkdir -p ~/.insightface/models &&
        echo 'âœ… Iniciando servidor...' &&
        python app.py
      "
    expose:
      - "5000"
    environment:
      PORT: 5000
      PYTHONUNBUFFERED: "1"
    volumes:
      - .:/app
      - models_data:/root/.insightface/models
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 300s

volumes:
  models_data: